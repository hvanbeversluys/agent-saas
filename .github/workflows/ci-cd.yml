# =============================================================================
# GitHub Actions - CI/CD Pipeline
# =============================================================================
# Build, Test et Deploy pour Agent SaaS
# =============================================================================

name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ${{ github.repository }}/frontend
  BACKEND_IMAGE: ${{ github.repository }}/backend

jobs:
  # ===========================================================================
  # Build & Test
  # ===========================================================================
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # ----- Backend (Python) -----
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: ğŸ§ª Run backend tests
        run: |
          cd backend
          python -c "from database import init_db; init_db()"
          # pytest --cov=. --cov-report=xml || echo "No tests yet"

      # ----- Frontend (Next.js) -----
      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install frontend dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile

      - name: ğŸ” Lint frontend
        run: |
          cd frontend
          bun run lint || echo "Lint warnings"

      - name: ğŸ—ï¸ Build frontend
        run: |
          cd frontend
          bun run build
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.API_URL_DEV }}

  # ===========================================================================
  # Build Docker Images
  # ===========================================================================
  build-images:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: ğŸ·ï¸ Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: ğŸ³ Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}

      - name: ğŸ³ Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.dev
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

  # ===========================================================================
  # Deploy to Staging
  # ===========================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-images
    environment: staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "   Images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest"
          echo "   Images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest"
          # Ajouter ici le dÃ©ploiement rÃ©el (SSH, kubectl, etc.)
          # Exemple avec SSH:
          # ssh ${{ secrets.STAGING_HOST }} "cd /app && docker compose pull && docker compose up -d"

  # ===========================================================================
  # Deploy to Production (manual trigger)
  # ===========================================================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŒŸ Deploy to Production
        run: |
          echo "ğŸŒŸ Deploying to production environment..."
          echo "   This requires manual approval in GitHub"
          # Ajouter ici le dÃ©ploiement rÃ©el
